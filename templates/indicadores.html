<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Indicadores de Treinamentos</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f5ffe6;
      --brand:#c1f38e;
      --btn:#a0e76d;
      --accent:#97de66;
      --card:#ffffff;
      --muted:#667085;
      --bord:#e6e6e6;
      --ink:#1b1b1b;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:'Poppins',sans-serif; background: var(--bg); color:var(--ink); }
    .layout { display:flex; min-height:100vh; }
    .sidebar {
      width:260px; background:#fff; border-right:1px solid #e6e6e6; padding:28px 18px; display:flex; flex-direction:column;
      align-items:center;
    }
    .logo { width:160px; margin-bottom:18px; }
    .avatar { width:76px; height:76px; border-radius:50%; background:#eef7df; border:4px solid #d8f5c8; margin-bottom:12px; }
    .user-name { font-weight:700; margin-bottom:18px; text-align:center; }
    .sidebar .btn { display:block; width:100%; text-align:center; padding:10px; background:var(--btn); border-radius:8px; margin-bottom:12px; text-decoration:none; color:#111; font-weight:700; }
    .main { flex:1; padding:28px 36px; }

    h1 { margin:0 0 18px 0; font-size:26px; font-weight:800; color:#1b1b1b; }

    .cards { display:flex; gap:18px; flex-wrap:wrap; margin-bottom:22px; }
    .card {
      background:var(--card); border-left:6px solid var(--btn); padding:18px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.03);
      min-width:220px; max-width:320px; flex:1;
    }
    .card h3 { margin:0; font-size:14px; color:var(--muted); font-weight:700; }
    .card .value { margin-top:8px; font-size:20px; font-weight:800; color: #196a12; }

    .section { background:var(--card); border-radius:10px; padding:14px; border:1px solid var(--bord); margin-bottom:18px; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px 12px; border-bottom:1px solid #f1f7ea; text-align:left; }
    th { background:#eef7df; font-weight:800; color:#2d6b1a; }
    .empty { color:var(--muted); padding:14px; text-align:center; }

    .note { color:var(--muted); font-size:13px; margin-top:6px; }

    @media (max-width:980px){
      .cards { flex-direction:column; }
      .sidebar { display:none; }
      .main { padding:18px; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <img class="logo" src="{{ url_for('static', filename='loggo.png') }}" alt="Logo">
      <div class="avatar" aria-hidden="true"></div>
      <div class="user-name">{{ session.get('nome', session.get('usuario')) }}</div>
      <a class="btn" href="{{ url_for('home') }}">Voltar</a>
      <a class="btn" href="{{ url_for('acompanhamento') }}">Acompanhamento</a>
    </aside>

    <main class="main">
      <h1>Indicadores de Treinamentos</h1>

      <div class="cards" role="region" aria-label="Indicadores principais">
        <div class="card">
          <h3>Total de Cursos Cadastrados</h3>
          <div class="value">{{ total_cursos or 0 }}</div>
          <div class="note">Cursos ativos no sistema</div>
        </div>

        <div class="card">
          <h3>Total de Treinamentos Concluídos</h3>
          <div class="value">{{ total_concluidos or 0 }}</div>
          <div class="note">Concluídos (regra completa: módulos+prova+presença+certificado)</div>
        </div>

        <div class="card">
          <h3>Treinamentos Pendentes</h3>
          <div class="value">{{ total_pendentes or 0 }}</div>
          <div class="note">Atribuídos mas não concluídos</div>
        </div>

        <div class="card">
          <h3>Taxa de Conclusão (%)</h3>
          <div class="value">{{ porcentagem_conclusao or 0 }}%</div>
          <div class="note">Concluídos / Atribuídos</div>
        </div>

        <div class="card">
          <h3>Média de Cursos Concluídos por Aluno</h3>
          <div class="value">
            {% if total_alunos and total_alunos > 0 %}
              {{ (total_concluidos / total_alunos) | round(2) }}
            {% else %}
              0
            {% endif %}
          </div>
          <div class="note">Média simples por aluno</div>
        </div>

        <div class="card">
          <h3>Top Cursos por Conclusão (ano)</h3>
          <div class="value" style="font-size:14px; color:#2a2a2a; font-weight:700;">
            {% if top_cursos %}
              {% for c, n in top_cursos %}
                {{ loop.index }}. {{ c }} — {{ n }}<br>
              {% endfor %}
            {% else %}
              1. Sem dados
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Detalhamento por curso -->
      <div class="section" aria-labelledby="detalhe-title">
        <h2 id="detalhe-title" style="margin-top:0; font-size:16px;">Detalhamento por Curso</h2>
        {% if top_cursos %}
          <table>
            <thead>
              <tr><th>Curso</th><th>Concluídos</th><th>Alocados</th><th>Taxa de Conclusão</th></tr>
            </thead>
            <tbody>
              {% for nome, qtd in top_cursos %}
                <tr>
                  <td>{{ nome }}</td>
                  <td>{{ qtd }}</td>
                  <td>
                    {# procura quantas matrículas existem para esse curso #}
                    {% set alocados = (matriculas | selectattr("curso","equalto", nome) | list | length) %}
                    {{ alocados }}
                  </td>
                  <td>
                    {% if alocados > 0 %}
                      {{ ((qtd / alocados) * 100) | round(1) }}%
                    {% else %}
                      —
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="empty">Nenhum curso cadastrado</div>
        {% endif %}
      </div>

      <!-- Últimos treinamentos aplicados -->
      <div class="section" aria-labelledby="ultimos-title">
        <h2 id="ultimos-title" style="margin-top:0; font-size:16px;">Últimos treinamentos aplicados</h2>

        {% if ultimos %}
          <table>
            <thead>
              <tr><th>Data</th><th>Curso</th><th>Aluno</th></tr>
            </thead>
            <tbody>
              {% for it in ultimos %}
                <tr>
                  <td>{{ it.data or '—' }} {{ it.hora or '' }}</td>
                  <td>{{ it.curso }}</td>
                  <td>{{ it.aluno }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="empty">Sem treinamentos registrados</div>
        {% endif %}
      </div>

      <div class="section">
        <h3 style="margin:0 0 8px 0;">Observações</h3>
        <p class="note">Use estes indicadores para avaliar desempenho dos treinamentos. Posso adicionar gráficos (Chart.js) ou exportação CSV se quiser.</p>
      </div>
    </main>
  </div>
</body>
</html>
