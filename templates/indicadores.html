<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Indicadores de Treinamentos</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f5ffe6; --card:#ffffff; --muted:#667085; --bord:#e6e6e6; --ink:#1b1b1b; --btn:#a0e76d;
    }
    *{box-sizing:border-box} body{ margin:0; font-family:'Poppins',sans-serif; background: var(--bg); color:var(--ink); }
    .layout { display:flex; min-height:100vh; }
    .sidebar { width:260px; background:#fff; border-right:1px solid #e6e6e6; padding:28px 18px; display:flex; flex-direction:column; align-items:center; }
    .logo { width:160px; margin-bottom:18px; } .avatar { width:76px; height:76px; border-radius:50%; background:#eef7df; border:4px solid #d8f5c8; margin-bottom:12px; }
    .user-name { font-weight:700; margin-bottom:18px; text-align:center; } .sidebar .btn { display:block; width:100%; text-align:center; padding:10px; background:var(--btn); border-radius:8px; margin-bottom:12px; text-decoration:none; color:#111; font-weight:700; }
    .main { flex:1; padding:28px 36px; }
    h1 { margin:0 0 18px 0; font-size:26px; font-weight:800; color:#1b1b1b; }
    .cards { display:flex; gap:18px; flex-wrap:wrap; margin-bottom:22px; }
    .card { background:var(--card); border-left:6px solid #a0e76d; padding:18px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.03); min-width:220px; max-width:320px; flex:1; }
    .card h3 { margin:0; font-size:14px; color:var(--muted); font-weight:700; } .card .value { margin-top:8px; font-size:20px; font-weight:800; color:#196a12; }
    .section { background:var(--card); border-radius:10px; padding:14px; border:1px solid var(--bord); margin-bottom:18px; }
    table { width:100%; border-collapse:collapse; } th, td { padding:10px 12px; border-bottom:1px solid #f1f7ea; text-align:left; } th { background:#eef7df; font-weight:800; color:#2d6b1a; }
    .empty { color:var(--muted); padding:14px; text-align:center; }
    .search-row { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
    .search-row input { flex:1; padding:10px 12px; border-radius:8px; border:1px solid #e6eedf; background:#fbfff7; }
    .small-note { color:var(--muted); font-size:13px; margin-top:6px; }
    @media (max-width:980px){ .cards { flex-direction:column; } .sidebar { display:none; } .main { padding:18px; } }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <img class="logo" src="{{ url_for('static', filename='loggo.png') }}" alt="Logo">
      <div class="avatar" aria-hidden="true"></div>
      <div class="user-name">{{ session.get('nome', session.get('usuario')) }}</div>
      <a class="btn" href="{{ url_for('home') }}">Voltar</a>
      <a class="btn" href="{{ url_for('acompanhamento') }}">Acompanhamento</a>
    </aside>

    <main class="main">
      <h1>Indicadores de Treinamentos</h1>

      <div class="cards" role="region" aria-label="Indicadores principais">
        <div class="card">
          <h3>Total de Cursos Cadastrados</h3>
          <div class="value">{{ total_cursos or 0 }}</div>
          <div class="small-note">Cursos ativos no sistema</div>
        </div>

        <div class="card">
          <h3>Total de Treinamentos Concluídos</h3>
          <div class="value">{{ total_concluidos or 0 }}</div>
          <div class="small-note">Concluídos (regra completa: módulos+prova+presença+certificado)</div>
        </div>

        <div class="card">
          <h3>Treinamentos Pendentes</h3>
          <div class="value">{{ total_pendentes or 0 }}</div>
          <div class="small-note">Atribuídos mas não concluídos</div>
        </div>

        <div class="card">
          <h3>Taxa de Conclusão (%)</h3>
          <div class="value">{{ porcentagem_conclusao or 0 }}%</div>
          <div class="small-note">Concluídos / Atribuídos</div>
        </div>
      </div>

      <!-- Detalhamento por curso com pesquisa -->
      <div class="section" aria-labelledby="detalhe-title">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <h2 id="detalhe-title" style="margin:0; font-size:16px;">Detalhamento por Curso</h2>
        </div>

        <div class="search-row">
          <input id="cursoSearch" type="search" placeholder="Pesquisar curso por nome..." aria-label="Pesquisar curso">
          <button type="button" onclick="resetSearch()">Limpar</button>
        </div>

        <div id="tableWrap">
          {% if course_details %}
            <table id="coursesTable" role="table" aria-label="Detalhamento por curso">
              <thead>
                <tr><th>Curso</th><th>Concluídos</th><th>Alocados</th><th>Taxa de Conclusão</th></tr>
              </thead>
              <tbody>
                {% for it in course_details %}
                  <tr data-name="{{ it.nome|lower }}">
                    <td>{{ it.nome }}</td>
                    <td>{{ it.concluidos }}</td>
                    <td>{{ it.alocados }}</td>
                    <td>
                      {% if it.taxa is not none %}
                        {{ it.taxa }}%
                      {% else %}
                        —
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div class="empty">Nenhum curso cadastrado</div>
          {% endif %}
        </div>
      </div>

      <!-- Últimos treinamentos aplicados -->
      <div class="section" aria-labelledby="ultimos-title">
        <h2 id="ultimos-title" style="margin-top:0; font-size:16px;">Últimos treinamentos aplicados</h2>
        {% if ultimos %}
          <table>
            <thead><tr><th>Data</th><th>Curso</th><th>Aluno</th></tr></thead>
            <tbody>
              {% for it in ultimos %}
                <tr><td>{{ it.data or '—' }} {{ it.hora or '' }}</td><td>{{ it.curso }}</td><td>{{ it.aluno }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="empty">Sem treinamentos registrados</div>
        {% endif %}
      </div>

      <div class="section">
        <h3 style="margin:0 0 8px 0;">Observações</h3>
        <p class="small-note">Use estes indicadores para avaliar desempenho dos treinamentos. Posso adicionar gráficos (Chart.js) ou exportação CSV se quiser.</p>
      </div>
    </main>
  </div>

<script>
  // busca em tempo real na tabela
  (function(){
    const input = document.getElementById('cursoSearch');
    const tbody = document.querySelector('#coursesTable tbody');
    if(!input || !tbody) return;

    input.addEventListener('input', function(){
      const q = input.value.trim().toLowerCase();
      tbody.querySelectorAll('tr').forEach(tr=>{
        const name = tr.getAttribute('data-name') || '';
        tr.style.display = name.includes(q) ? '' : 'none';
      });
    });
  })();

  function resetSearch(){
    const input = document.getElementById('cursoSearch');
    if(input){ input.value = ''; input.dispatchEvent(new Event('input')); }
  }
</script>
</body>
</html>
