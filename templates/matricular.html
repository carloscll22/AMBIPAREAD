<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Matricular Aluno</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#c1f38e; --primary:#a0e76d; --primary-hover:#8dd24a; --surface:#fff;
      --border:#e2e8f0; --text:#1f2937; --muted:#64748b; --shadow:0 8px 22px rgba(0,0,0,.08);
      --radius:16px; --radius-sm:12px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Poppins',sans-serif; min-height:100vh; background:var(--bg); color:var(--text);
      display:grid; grid-template-columns:260px 1fr; gap:22px; padding:22px;
    }

    /* ===== Sidebar (igual cadastro de curso) ===== */
    .sidebar{background:var(--surface);border-right:1px solid var(--border);padding:18px 16px;display:flex;flex-direction:column;gap:16px}
    .brand{background:#f4ffe7;border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:center}
    .brand img{height:32px;width:auto;display:block}

    .profile{background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;align-items:center;gap:10px}
    .avatar-wrap{position:relative;width:86px;height:86px}
    .avatar{width:86px;height:86px;border-radius:50%;background-position:center;background-size:cover;background-repeat:no-repeat;border:3px solid #d9f5b6}
    .avatar-btn{position:absolute;right:-4px;bottom:-4px;background:var(--primary);border:none;border-radius:999px;padding:6px 8px;font-weight:700;cursor:pointer;line-height:1;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    .avatar-btn:hover{background:var(--primary-hover)}
    .user-name{text-align:center;font-weight:700;color:#222;font-size:14px;letter-spacing:.02em;text-transform:uppercase}

    .btn-side{width:100%;display:inline-block;text-align:center;padding:10px 14px;border:none;border-radius:10px;background:var(--primary);color:#333;font-weight:600;text-decoration:none;cursor:pointer;transition:.15s ease}
    .btn-side:hover{background:var(--primary-hover)}
    .btn-side.secondary{background:#eef2f6;color:#111;border:1px solid var(--border)}

    /* ===== Conteúdo ===== */
    .content{padding-right:22px}
    .card{
      background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
      padding:24px; max-width:980px; margin:0 auto;
    }
    h2{ margin-bottom:16px; color:#1e293b; font-size:22px; font-weight:700; text-align:center }

    /* --- FORMATO HORIZONTAL (duas colunas) --- */
    form .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    .field{display:grid; grid-template-columns:170px 1fr; align-items:center; gap:10px; background:#fafafa; border:1px solid #ececec; border-radius:10px; padding:10px 12px}
    .field label{font-weight:700; font-size:13px; color:#374151}
    .field .ctrl{display:flex; gap:8px; align-items:center}
    select, input[type="text"], input[type="date"]{width:100%; padding:10px; border-radius:8px; border:1px solid #cbd5e1; font-size:14px}
    .hint{ grid-column:2 / 3; font-size:12px; color:#666 }

    .erro{ grid-column:1/-1; background:#ffe7e7; color:#a30000; padding:10px 12px; border-radius:8px; font-size:14px }

    .row-full{grid-column:1/-1}
    .submit-wrap{grid-column:1/-1; display:flex; justify-content:center; margin-top:6px}
    input[type="submit"]{ width:320px; padding:12px; background:var(--primary); border:none; border-radius:10px; cursor:pointer; font-weight:700; font-size:16px; color:#333; transition:background .2s}
    input[type="submit"]:hover{ background:var(--primary-hover) }
    .link-voltar{ display:block; margin-top:14px; text-align:center; text-decoration:none; color:#333; font-weight:600 }

    /* linha aluno existente */
    .aluno-row{display:flex; align-items:center; gap:6px; width:100%}
    .add-btn{ padding:8px 10px; border-radius:8px; border:1px solid #cbd5e1; background:#f6f6f6; cursor:pointer }

    @media (max-width:980px){
      body{grid-template-columns:1fr}
      .content{padding-right:0}
      form .grid{grid-template-columns:1fr}
      .field{grid-template-columns:1fr; align-items:start}
      .hint{grid-column:1/2}
    }
  </style>
</head>
<body>

  <!-- ===== Sidebar ===== -->
  <aside class="sidebar">
    <div class="brand">
      <img src="{{ url_for('static', filename='loggo.png') }}" alt="Ambipar EAD">
    </div>

    <div class="profile">
      <div class="avatar-wrap">
        <div class="avatar"
          style="
            background-image:
              url('{{ url_for('static', filename='avatars/' + session['usuario'].replace('@','_at_').replace('.','_') + '.webp') }}'),
              url('{{ url_for('static', filename='avatars/' + session['usuario'].replace('@','_at_').replace('.','_') + '.jpg') }}'),
              url('{{ url_for('static', filename='avatars/' + session['usuario'].replace('@','_at_').replace('.','_') + '.jpeg') }}'),
              url('{{ url_for('static', filename='avatars/' + session['usuario'].replace('@','_at_').replace('.','_') + '.png') }}'),
              url('{{ url_for('static', filename='avatar_padrao.png') }}');
          ">
        </div>
        <button class="avatar-btn" type="button" title="Trocar foto" onclick="document.getElementById('fotoInputProf').click()">✎</button>
        <form id="fotoFormProf" action="{{ url_for('upload_foto') }}" method="POST" enctype="multipart/form-data" style="display:none">
          <input id="fotoInputProf" type="file" name="foto" accept=".png,.jpg,.jpeg,.webp" onchange="document.getElementById('fotoFormProf').submit()">
        </form>
      </div>
      <div class="user-name">{{ (session['nome'] or 'USUÁRIO') | upper }}</div>
    </div>

    <a class="btn-side" href="/alterar_senha">Alterar Senha</a>
    <a class="btn-side secondary" href="/">Home do Professor</a>
  </aside>

  <!-- ===== Conteúdo ===== -->
  <main class="content">
    <div class="card">
      <h2>Matricular Aluno em Curso</h2>

      {% if erro %}
        <div class="erro">{{ erro }}</div>
      {% endif %}

      <form method="post">
        <div class="grid">

          <!-- Aluno + botão "Adicionar outro aluno" (inline) -->
          <div class="field row-full">
            <label for="aluno">Aluno:</label>
            <div class="ctrl">
              <div id="alunosContainer" style="flex:1">
                <div class="aluno-row">
                  <select name="alunos[]" id="aluno" required style="flex:1;">
                    {% for aluno in alunos %}
                      <option value="{{ aluno.email }}">{{ aluno.nome }}</option>
                    {% endfor %}
                  </select>
                  <button type="button" class="remove-aluno" title="Remover" aria-label="Remover"
                          style="display:none; padding:8px 10px; border-radius:8px; border:1px solid #cbd5e1; background:#f6f6f6; cursor:pointer;">
                    ✕
                  </button>
                </div>
              </div>
              <button type="button" class="add-btn" onclick="addAluno()">Adicionar outro aluno</button>
            </div>
          </div>

          <div class="field">
            <label for="curso">Curso:</label>
            <div class="ctrl">
              <select name="curso" id="curso" required>
                {% for curso in cursos %}
                  <option value="{{ curso.nome }}">{{ curso.nome }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="field">
            <label for="professor">Professor:</label>
            <div class="ctrl">
              <select name="professor" id="professor" required>
                {% for prof in professores %}
                  <option value="{{ prof }}">{{ prof }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="field">
            <label for="tipo">Tipo:</label>
            <div class="ctrl">
              <select name="tipo" id="tipo" required>
                <option value="Inicial">Inicial</option>
                <option value="Periódico">Periódico</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label for="turma">Turma (3 dígitos):</label>
            <div class="ctrl">
              <input type="text" id="turma" name="turma"
                placeholder="{{ sugestao_turma or '001' }}"
                inputmode="numeric" autocomplete="off" pattern="[0-9]{3}"
                title="Use exatamente 3 dígitos (ex.: 001, 002)"
                oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,3)">
            </div>
            <div class="hint">Se deixar em branco, o sistema gera o próximo número automaticamente.</div>
          </div>

          <div class="field">
            <label for="nrt">NRT da Turma:</label>
            <div class="ctrl">
              <input type="text" id="nrt" name="nrt" placeholder="Ex: NRT-2025-01" required>
            </div>
          </div>

          <div class="field">
            <label for="periodicidade">Periodicidade de vencimento:</label>
            <div class="ctrl">
              <select id="periodicidade" name="periodicidade" required>
                <option value="1">1 ano</option>
                <option value="2">2 anos</option>
                <option value="3">3 anos</option>
                <option value="5">5 anos</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label for="data_inicio">Data Início:</label>
            <div class="ctrl">
              <input type="date" id="data_inicio" name="data_inicio" required>
            </div>
          </div>

          <div class="field">
            <label for="data_fim">Data Fim:</label>
            <div class="ctrl">
              <input type="date" id="data_fim" name="data_fim" required>
            </div>
          </div>

          <div class="submit-wrap">
            <input type="submit" value="Matricular" />
          </div>

          <a href="/" class="link-voltar row-full">Voltar</a>
        </div>
      </form>
    </div>
  </main>

  <!-- ===== JS original (mantido) ===== -->
  <script>
    const sugestoesPorCurso = {{ sugestoes_por_curso|tojson|safe if sugestoes_por_curso is defined else '{}' }};
    const cursoSelect = document.getElementById('curso');
    const turmaInput  = document.getElementById('turma');

    function atualizaPlaceholder() {
      const nome = cursoSelect.value;
      const sug = sugestoesPorCurso[nome] || '001';
      turmaInput.placeholder = sug;
      turmaInput.value = '';
    }
    atualizaPlaceholder();
    cursoSelect.addEventListener('change', atualizaPlaceholder);
  </script>

  <script>
    function addAluno() {
      const container = document.getElementById('alunosContainer');
      const firstSelect = document.getElementById('aluno');

      const row = document.createElement('div');
      row.className = 'aluno-row';

      const clone = firstSelect.cloneNode(true);
      clone.removeAttribute('id');
      clone.name = 'alunos[]';
      clone.required = true;
      clone.style.flex = '1';

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.title = 'Remover';
      btn.setAttribute('aria-label', 'Remover');
      btn.textContent = '✕';
      btn.style.padding = '8px 10px';
      btn.style.borderRadius = '8px';
      btn.style.border = '1px solid #cbd5e1';
      btn.style.background = '#f6f6f6';
      btn.style.cursor = 'pointer';
      btn.onclick = function () { removerAluno(btn); };

      row.appendChild(clone);
      row.appendChild(btn);
      container.appendChild(row);
    }

    function removerAluno(btn) {
      const container = document.getElementById('alunosContainer');
      const rows = container.querySelectorAll('.aluno-row');
      if (rows.length <= 1) {
        const sel = rows[0].querySelector('select');
        if (sel) sel.selectedIndex = 0;
        return;
      }
      btn.parentElement.remove();
    }
  </script>
</body>
</html>
