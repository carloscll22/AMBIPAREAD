<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Matricular Aluno</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#c1f38e;
      --primary:#a0e76d;
      --primary-hover:#8dd24a;
      --surface:#ffffff;
      --border:#e2e8f0;
      --text:#1f2937;
      --muted:#64748b;
      --shadow:0 8px 22px rgba(0,0,0,.08);
      --radius:16px; --radius-sm:12px;
    }
    *{box-sizing:border-box;margin:0;padding:0}

    /* ===== Layout geral com sidebar (igual ao cadastro de curso) ===== */
    body{
      font-family:'Poppins',sans-serif;
      min-height:100vh; background:var(--bg); color:var(--text);
      display:grid; grid-template-columns:260px 1fr; gap:22px;
      padding:22px;
    }

    /* ===== Sidebar ===== */
    .sidebar{background:var(--surface);border-right:1px solid var(--border);padding:18px 16px;display:flex;flex-direction:column;gap:16px}
    .brand{background:#f4ffe7;border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:center}
    .brand img{height:32px;width:auto;display:block}

    .profile{
      background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);
      padding:14px;display:flex;flex-direction:column;align-items:center;gap:10px
    }
    .avatar-wrap{position:relative;width:86px;height:86px}
    .avatar{
      width:86px;height:86px;border-radius:50%;
      background-position:center;background-size:cover;background-repeat:no-repeat;
      border:3px solid #d9f5b6;
    }
    .avatar-btn{
      position:absolute;right:-4px;bottom:-4px;
      background:var(--primary);border:none;border-radius:999px;padding:6px 8px;
      font-weight:700;cursor:pointer;line-height:1;box-shadow:0 2px 6px rgba(0,0,0,.15)
    }
    .avatar-btn:hover{background:var(--primary-hover)}
    .user-name{
      text-align:center;font-weight:700;color:#222;font-size:14px;letter-spacing:.02em;text-transform:uppercase
    }

    .btn-side{
      width:100%;display:inline-block;text-align:center;
      padding:10px 14px;border:none;border-radius:10px;background:var(--primary);color:#333;font-weight:600;
      text-decoration:none;cursor:pointer;transition:.15s ease
    }
    .btn-side:hover{background:var(--primary-hover)}
    .btn-side.secondary{background:#eef2f6;color:#111;border:1px solid var(--border)}

    /* ===== Conteúdo (mantém seu formulário) ===== */
    .content{padding-right:22px}
    .box{
      background:#fff; padding:25px 30px; border-radius:10px; width:360px; box-shadow:0 0 8px rgba(0,0,0,.1); text-align:left;
      /* Centraliza no conteúdo sem perder sua largura original */
      margin:0 auto;
    }
    h2{ text-align:center; margin-bottom:25px; color:#333; }
    label{ display:block; margin-top:15px; font-weight:bold; color:#444; }
    select, input[type="text"], input[type="date"]{ width:100%; padding:8px; margin-top:6px; border-radius:6px; border:1px solid #ccc; font-size:15px; box-sizing:border-box; }
    .hint{ font-size:12px; color:#666; margin-top:4px; }
    .erro{ margin-top:10px; background:#ffe7e7; color:#a30000; padding:8px 10px; border-radius:6px; font-size:14px; }
    input[type="submit"]{ margin-top:25px; width:100%; padding:12px; background:#a0e76d; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:16px; color:#333; transition:background .3s; }
    input[type="submit"]:hover{ background:#8dd24a; }
    .link-voltar{ display:block; margin-top:20px; text-align:center; text-decoration:none; color:#333; font-weight:bold; }
    .link-voltar:hover{ text-decoration:underline; }

    /* linha aluno existente */
    .aluno-row{display:flex; align-items:center; gap:6px; margin-top:6px}
    @media (max-width:980px){
      body{grid-template-columns:1fr}
      .content{padding-right:0}
    }
  </style>
</head>
<body>

  <!-- ===== Sidebar igual à do cadastro de curso ===== -->
  <aside class="sidebar">
    <!-- LOGO Ambipar -->
    <div class="brand">
      <img src="{{ url_for('static', filename='loggo.png') }}" alt="Ambipar EAD">
    </div>

    <!-- Avatar editável + Nome do usuário -->
    <div class="profile">
      <div class="avatar-wrap">
        <div
          class="avatar"
          style="
            background-image:
              url('{{ url_for('static', filename='avatars/' + session['usuario'].replace('@','_at_').replace('.','_') + '.webp') }}'),
              url('{{ url_for('static', filename='avatars/' + session['usuario'].replace('@','_at_').replace('.','_') + '.jpg') }}'),
              url('{{ url_for('static', filename='avatars/' + session['usuario'].replace('@','_at_').replace('.','_') + '.jpeg') }}'),
              url('{{ url_for('static', filename='avatars/' + session['usuario'].replace('@','_at_').replace('.','_') + '.png') }}'),
              url('{{ url_for('static', filename='avatar_padrao.png') }}');
          ">
        </div>
        <button class="avatar-btn" type="button" title="Trocar foto" onclick="document.getElementById('fotoInputProf').click()">✎</button>
        <form id="fotoFormProf" action="{{ url_for('upload_foto') }}" method="POST" enctype="multipart/form-data" style="display:none">
          <input id="fotoInputProf" type="file" name="foto" accept=".png,.jpg,.jpeg,.webp" onchange="document.getElementById('fotoFormProf').submit()">
        </form>
      </div>
      <div class="user-name">{{ (session['nome'] or 'USUÁRIO') | upper }}</div>
    </div>

    <!-- Mesmos links já existentes no projeto -->
    <a class="btn-side" href="/alterar_senha">Alterar Senha</a>
    <a class="btn-side secondary" href="/">Home do Professor</a>
  </aside>

  <!-- ===== Conteúdo original da página de matrícula ===== -->
  <main class="content">
    <div class="box">
      <h2>Matricular Aluno em Curso</h2>

      {% if erro %}
        <div class="erro">{{ erro }}</div>
      {% endif %}

      <form method="post">
        <label for="aluno">Aluno:</label>
        <div id="alunosContainer">
          <!-- primeira linha (não removível) -->
          <div class="aluno-row">
            <select name="alunos[]" id="aluno" required style="flex:1;">
              {% for aluno in alunos %}
                <option value="{{ aluno.email }}">{{ aluno.nome }}</option>
              {% endfor %}
            </select>
            <button type="button" class="remove-aluno" title="Remover" aria-label="Remover"
                    style="display:none; padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:#f6f6f6; cursor:pointer;">
              ✕
            </button>
          </div>
        </div>
        <button type="button" onclick="addAluno()" style="margin-top:8px; padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:#f6f6f6; cursor:pointer;">
          Adicionar outro aluno
        </button>

        <label for="curso">Curso:</label>
        <select name="curso" id="curso" required>
          {% for curso in cursos %}
            <option value="{{ curso.nome }}">{{ curso.nome }}</option>
          {% endfor %}
        </select>

        <label for="professor">Professor:</label>
        <select name="professor" id="professor" required>
          {% for prof in professores %}
            <option value="{{ prof }}">{{ prof }}</option>
          {% endfor %}
        </select>

        <!-- Tipo da matrícula -->
        <label for="tipo">Tipo:</label>
        <select name="tipo" id="tipo" required>
          <option value="Inicial">Inicial</option>
          <option value="Periódico">Periódico</option>
        </select>

        <!-- Turma (3 dígitos, opcional; se vazio o backend gera) -->
        <label for="turma">Turma (3 dígitos):</label>
        <input
          type="text"
          id="turma"
          name="turma"
          placeholder="{{ sugestao_turma or '001' }}"
          inputmode="numeric"
          autocomplete="off"
          pattern="[0-9]{3}"
          title="Use exatamente 3 dígitos (ex.: 001, 002)"
          oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,3)"
        />
        <div class="hint">Se deixar em branco, o sistema gera o próximo número automaticamente.</div>

        <!-- NRT -->
        <label for="nrt">NRT da Turma:</label>
        <input type="text" id="nrt" name="nrt" placeholder="Ex: NRT-2025-01" required>

        <!-- Periodicidade de vencimento -->
        <label for="periodicidade">Periodicidade de vencimento:</label>
        <select id="periodicidade" name="periodicidade" required>
          <option value="1">1 ano</option>
          <option value="2">2 anos</option>
          <option value="3">3 anos</option>
          <option value="5">5 anos</option>
        </select>

        <label for="data_inicio">Data Início:</label>
        <input type="date" id="data_inicio" name="data_inicio" required>

        <label for="data_fim">Data Fim:</label>
        <input type="date" id="data_fim" name="data_fim" required>

        <input type="submit" value="Matricular" />
      </form>

      <a href="/" class="link-voltar">Voltar</a>
    </div>
  </main>

  <!-- ===== JS original (mantido) ===== -->
  <script>
    const sugestoesPorCurso = {{ sugestoes_por_curso|tojson|safe if sugestoes_por_curso is defined else '{}' }};
    const cursoSelect = document.getElementById('curso');
    const turmaInput  = document.getElementById('turma');

    function atualizaPlaceholder() {
      const nome = cursoSelect.value;
      const sug = sugestoesPorCurso[nome] || '001';
      turmaInput.placeholder = sug;
      turmaInput.value = '';
    }

    atualizaPlaceholder();
    cursoSelect.addEventListener('change', atualizaPlaceholder);
  </script>

  <script>
    function addAluno() {
      const container = document.getElementById('alunosContainer');
      const firstSelect = document.getElementById('aluno');

      const row = document.createElement('div');
      row.className = 'aluno-row';

      const clone = firstSelect.cloneNode(true);
      clone.removeAttribute('id');
      clone.name = 'alunos[]';
      clone.required = true;
      clone.style.flex = '1';

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.title = 'Remover';
      btn.setAttribute('aria-label', 'Remover');
      btn.textContent = '✕';
      btn.style.padding = '6px 10px';
      btn.style.borderRadius = '6px';
      btn.style.border = '1px solid #ccc';
      btn.style.background = '#f6f6f6';
      btn.style.cursor = 'pointer';
      btn.onclick = function () { removerAluno(btn); };

      row.appendChild(clone);
      row.appendChild(btn);
      container.appendChild(row);
    }

    function removerAluno(btn) {
      const container = document.getElementById('alunosContainer');
      const rows = container.querySelectorAll('.aluno-row');
      if (rows.length <= 1) {
        const sel = rows[0].querySelector('select');
        if (sel) sel.selectedIndex = 0;
        return;
      }
      btn.parentElement.remove();
    }
  </script>
</body>
</html>
