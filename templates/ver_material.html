<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Visualizar Material</title>
  <style>
    body { background:#f5ffe6; font-family: Arial, sans-serif; margin:0; }

    .top-bar {
      background:#c1f38e;
      padding:16px 24px;
      font-weight:bold;
      font-size:20px;
      position: relative;
    }
    .btn-back {
      position:absolute;
      right:24px;
      top:50%;
      transform: translateY(-50%);
      background:#a0e76d;
      color:#1b1b1b;
      padding:8px 14px;
      border-radius:8px;
      text-decoration:none;
      font-weight:700;
      box-shadow:0 2px 5px rgba(0,0,0,.1);
    }
    .btn-back:hover { background:#8dd24a; }

    .container {
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:24px;
      padding: 20px 24px;
    }

    /* Menu lateral */
    .menu-lateral {
      background:#ffffff;
      border-radius:12px;
      padding:16px;
      height: calc(100vh - 120px);
      overflow-y:auto;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
    }
    .menu-lateral ul { list-style:none; margin:0; padding:0; }
    .menu-lateral li + li { margin-top:8px; }
    .menu-lateral a {
      display:block;
      padding:10px 12px;
      border-radius:8px;
      color:#222;
      text-decoration:none;
      font-weight:600;
    }
    .menu-lateral a:hover { background:#f0fadf; }
    .menu-lateral a.is-active {
      background:#e8f5d7;
      border-left:4px solid #97de66;
      padding-left:8px;
    }

    /* Conteúdo */
    .conteudo {
      background:#ffffff;
      border-radius:12px;
      padding:16px;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
    }

    .pdf-wrap { position:relative; }
    #pdfFrame {
      width:100%;
      min-height:70vh;
      max-height:85vh;
      border:1px solid #e6e6e6;
      border-radius:10px;
      display:block;
      background:#2b2b2b; /* evita “flash” branco */
    }

    .progress { margin-top:16px; background:#eef5e0; border-radius:10px; height:20px; overflow:hidden; position:relative; }
    .progress-bar { height:100%; background:#4CAF50; transition:width .4s; }
    .progress::after {
      content: attr(data-label);
      position:absolute; left:50%; top:0; transform:translateX(-50%);
      font-weight:700; color:#1b1b1b; font-size:12px; line-height:20px;
    }

    .nav-buttons { margin-top:16px; display:flex; gap:12px; justify-content:flex-end; }
    .btn {
      padding:10px 16px; background:#a0e76d; border:none; border-radius:8px;
      font-weight:700; color:#1b1b1b; cursor:pointer; transition:background .25s;
    }
    .btn:hover { background:#8dd24a; }
    .btn:disabled { background:#dcdcdc; cursor:not-allowed; }

    /* Botão Concluído fixo no topo direito */
    .btn-concluir-fixed{
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 1000;
      padding: 10px 16px;
      border: 0;
      border-radius: 12px;
      background: #16a34a; /* verde elegante */
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      transition: transform .06s ease, filter .15s ease, opacity .15s ease;
      opacity: 0.98;
    }
    .btn-concluir-fixed:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    .btn-concluir-fixed:active{ transform: translateY(0); filter: brightness(0.98); }
    /* Evita sobrepor a top-bar */
    .has-topbar .btn-concluir-fixed{ top: 64px; }

    @media (max-width: 992px) {
      .container { grid-template-columns: 1fr; }
      .menu-lateral { height:auto; margin-bottom:16px; }
      #pdfFrame { min-height:65vh; max-height:70vh; }
    }
    @media (max-width: 600px) {
      #pdfFrame { min-height:60vh; max-height:65vh; }
    }
  </style>
</head>
<body class="has-topbar">

  <div class="top-bar">
    Treinamento - {{ curso.nome }}
    <a class="btn-back" href="{{ url_for('home') }}">⬅ Voltar</a>
  </div>

  <div class="container">
    <!-- Menu lateral -->
    <div class="menu-lateral">
      <ul>
        {% for mod in curso.modulos %}
          {% set idx = loop.index0 %}
          <li>
            <a href="?modulo={{ idx }}" class="{{ 'is-active' if modulo_atual==idx else '' }}">
              Módulo {{ idx + 1 }} - {{ mod.titulo }}
              {% if progresso_individual and progresso_individual[idx] == 100 %} ✅{% endif %}
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>

    <!-- Conteúdo -->
    <div class="conteudo">
      {% if curso.modulos and modulo_atual is not none %}
        {% set raw = (curso.modulos[modulo_atual].arquivo or '') %}
        {% set cleaned = raw.replace('static/','').replace('conteudos/','').lstrip('/') %}
        {% set parts = cleaned.split('/') %}
        {% set fname = parts[-1] %}
        {% set pdf_url = url_for('uploads', filename=fname) %}

        <div class="pdf-wrap">
          <iframe id="pdfFrame" title="Material do módulo" allow="fullscreen"></iframe>
        </div>

        <small style="opacity:.6; display:block; margin-top:6px;">URL DEBUG: {{ pdf_url }}</small>

        <div class="progress" data-label="{{ progresso }}%">
          <div class="progress-bar" style="width: {{ progresso }}%"></div>
        </div>

        <div class="nav-buttons">
          <form method="get" id="form-anterior">
            <input type="hidden" name="modulo" value="{{ (modulo_atual if modulo_atual is not none else 0) - 1 }}">
            <button class="btn" type="submit"
              {% if not curso.modulos or modulo_atual is none or modulo_atual <= 0 %}disabled{% endif %}>
              ← Anterior
            </button>
          </form>
          <form method="get" id="form-proximo">
            <input type="hidden" name="modulo" value="{{ (modulo_atual if modulo_atual is not none else -1) + 1 }}">
            <button class="btn" type="submit"
              {% if not curso.modulos or modulo_atual is none or (modulo_atual + 1) >= (curso.modulos|length) %}disabled{% endif %}>
              Próximo →
            </button>
          </form>
        </div>

        {# REMOVIDO o bloco de botão no rodapé para evitar duplicidade #}
      {% else %}
        <p>Selecione um módulo ao lado para visualizar o conteúdo.</p>
      {% endif %}
    </div>
  </div>

  {# Botão Concluído FIXO no topo direito (mesma condição de antes) #}
  {% if curso.modulos and modulo_atual is not none
        and (modulo_atual + 1) == (curso.modulos|length)
        and (progresso|int) >= 100 %}
    <form method="post" action="/concluir/{{ curso.nome }}">
      <button id="concluirBtn" type="submit" class="btn-concluir-fixed" aria-label="Concluir e ir para a prova">
        Concluído
      </button>
    </form>
  {% endif %}

  <!-- Escolhe o viewer correto e garante URL ABSOLUTA -->
  <script>
    (function () {
      var rel = "{{ pdf_url }}";
      var abs = /^https?:\/\//i.test(rel) ? rel : (location.origin + rel);

      var frame = document.getElementById('pdfFrame');

      var ua = navigator.userAgent || navigator.vendor || window.opera;
      var isIOS = /iPad|iPhone|iPod/.test(ua);
      var isAndroid = /Android/i.test(ua);
      var isMobile = isIOS || isAndroid;

      if (isMobile) {
        var gdocs = "https://drive.google.com/viewerng/viewer?embedded=true&url=" + encodeURIComponent(abs);
        frame.src = gdocs;
      } else {
        frame.src = abs + "#zoom=page-width";
      }

      frame.addEventListener('error', function () {
        frame.outerHTML =
          '<div style="padding:12px;background:#fff;border:1px solid #e6e6e6;border-radius:10px;">' +
          'Não foi possível carregar o visualizador. ' +
          '<a href="'+ abs +'" target="_blank" style="font-weight:bold;color:#2a6;">Abrir o PDF em nova aba</a>' +
          '</div>';
      });
    })();
  </script>

  <!-- Atalhos de teclado -->
  <script>
    document.addEventListener("keydown", function(event) {
      if (event.key === "ArrowLeft") {
        const btnAnterior = document.querySelector("#form-anterior button");
        if (btnAnterior && !btnAnterior.disabled) {
          document.getElementById("form-anterior").submit();
        }
      }
      if (event.key === "ArrowRight") {
        const btnProximo = document.querySelector("#form-proximo button");
        if (btnProximo && !btnProximo.disabled) {
          document.getElementById("form-proximo").submit();
        }
      }
    });
  </script>
</body>
</html>
