<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Visualizar Material</title>
  <style>
    body { background:#f5ffe6; font-family: Arial, sans-serif; margin:0; }

    .top-bar {
      background:#c1f38e;
      padding:16px 24px;
      font-weight:bold;
      font-size:20px;
      position: relative;
    }
    .btn-back {
      position:absolute;
      right:24px;
      top:50%;
      transform: translateY(-50%);
      background:#a0e76d;
      color:#1b1b1b;
      padding:8px 14px;
      border-radius:8px;
      text-decoration:none;
      font-weight:700;
      box-shadow:0 2px 5px rgba(0,0,0,.1);
    }
    .btn-back:hover { background:#8dd24a; }

    .container {
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:24px;
      padding: 20px 24px;
    }

    .menu-lateral {
      background:#ffffff;
      border-radius:12px;
      padding:16px;
      height: calc(100vh - 120px);
      overflow-y:auto;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
    }
    .menu-lateral ul { list-style:none; margin:0; padding:0; }
    .menu-lateral li + li { margin-top:8px; }
    .menu-lateral a {
      display:block;
      padding:10px 12px;
      border-radius:8px;
      color:#222;
      text-decoration:none;
      font-weight:600;
    }
    .menu-lateral a:hover { background:#f0fadf; }
    .menu-lateral a.is-active {
      background:#e8f5d7;
      border-left:4px solid #97de66;
      padding-left:8px;
    }

    .conteudo {
      background:#ffffff;
      border-radius:12px;
      padding:16px;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
    }

    /* Iframe com rolagem e responsividade */
    iframe {
      width:100%;
      min-height: 70vh;
      max-height: 85vh;
      border:1px solid #e6e6e6;
      border-radius:10px;
      overflow:auto;
    }

    .progress { margin-top:16px; background:#eef5e0; border-radius:10px; height:20px; overflow:hidden; position:relative; }
    .progress-bar { height:100%; background:#4CAF50; transition:width .4s; }
    .progress::after {
      content: attr(data-label);
      position:absolute; left:50%; top:0; transform:translateX(-50%);
      font-weight:700; color:#1b1b1b; font-size:12px; line-height:20px;
    }

    .nav-buttons {
      margin-top:16px; display:flex; gap:12px; justify-content:flex-end;
    }
    .btn {
      padding:10px 16px; background:#a0e76d; border:none; border-radius:8px;
      font-weight:700; color:#1b1b1b; cursor:pointer; transition:background .25s;
    }
    .btn:hover { background:#8dd24a; }
    .btn:disabled { background:#dcdcdc; cursor:not-allowed; }

    /* Responsivo */
    @media (max-width: 992px) {
      .container { grid-template-columns: 1fr; }
      .menu-lateral { height:auto; margin-bottom:16px; }
      iframe { min-height:65vh; max-height:70vh; }
    }
    @media (max-width: 600px) {
      iframe { min-height:60vh; max-height:65vh; }
    }
  </style>
</head>
<body>

  <div class="top-bar">
    Inicial - {{ curso.nome }}
    <a class="btn-back" href="{{ url_for('home') }}">⬅ Voltar</a>
  </div>

  <div class="container">
    <div class="menu-lateral">
      <ul>
        {% for mod in curso.modulos %}
          {% set idx = loop.index0 %}
          <li>
            <a href="?modulo={{ idx }}" class="{{ 'is-active' if modulo_atual==idx else '' }}">
              Módulo {{ idx + 1 }} - {{ mod.titulo }}
              {% if progresso_individual and progresso_individual[idx] == 100 %} ✅{% endif %}
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>

    <div class="conteudo">
      {% if curso.modulos and modulo_atual is not none %}
        {% set raw = (curso.modulos[modulo_atual].arquivo or '') %}
        {% set cleaned = raw.replace('static/','').replace('conteudos/','').lstrip('/') %}
        {% set parts = cleaned.split('/') %}
        {% set fname = parts[-1] %}

        <!-- Scroll interno ativo -->
        <iframe src="{{ url_for('uploads', filename=fname) }}" frameborder="0"></iframe>

        <small style="opacity:.6">URL DEBUG: {{ url_for('uploads', filename=fname) }}</small>

        <div class="progress" data-label="{{ progresso }}%">
          <div class="progress-bar" style="width: {{ progresso }}%"></div>
        </div>

        <div class="nav-buttons">
          <form method="get" id="form-anterior">
            <input type="hidden" name="modulo" value="{{ (modulo_atual if modulo_atual is not none else 0) - 1 }}">
            <button class="btn" type="submit"
              {% if not curso.modulos or modulo_atual is none or modulo_atual <= 0 %}disabled{% endif %}>
              ← Anterior
            </button>
          </form>
          <form method="get" id="form-proximo">
            <input type="hidden" name="modulo" value="{{ (modulo_atual if modulo_atual is not none else -1) + 1 }}">
            <button class="btn" type="submit"
              {% if not curso.modulos or modulo_atual is none or (modulo_atual + 1) >= (curso.modulos|length) %}disabled{% endif %}>
              Próximo →
            </button>
          </form>
        </div>

        {% if curso.modulos and modulo_atual is not none
              and (modulo_atual + 1) == (curso.modulos|length)
              and (progresso|int) >= 100 %}
          <div class="concluir" style="margin-top:16px; text-align:right;">
            <form method="post" action="/concluir/{{ curso.nome }}">
              <button id="concluirBtn" type="submit" class="btn">Concluído</button>
            </form>
          </div>
        {% endif %}
      {% else %}
        <p>Selecione um módulo ao lado para visualizar o conteúdo.</p>
      {% endif %}
    </div>
  </div>
</body>
</html>
