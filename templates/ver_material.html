<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Visualizar Material</title>
  <style>
    body { background:#f5ffe6; font-family: Arial, sans-serif; margin:0; }

    .top-bar {
      background:#c1f38e;
      padding:16px 24px;
      font-weight:bold;
      font-size:20px;
      position: relative;
    }

    /* A√ß√µes no topo (Conclu√≠do + Voltar) alinhadas √† direita */
    .top-actions{
      position:absolute;
      right:24px;
      top:50%;
      transform: translateY(-50%);
      display:flex;
      gap:12px;
      align-items:center;
    }

    .btn-top{
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 14px; border-radius:8px; text-decoration:none; font-weight:700;
      box-shadow:0 2px 5px rgba(0,0,0,.1); border:0; cursor:pointer;
    }
    .btn-back {
      background:#a0e76d; color:#1b1b1b;
    }
    .btn-back:hover { background:#8dd24a; }

    .btn-concluir-top{
      background:#16a34a; color:#fff; border:0;
    }
    .btn-concluir-top:hover{ filter: brightness(1.05); }

    .container {
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:24px;
      padding: 20px 24px;
    }

    /* Menu lateral */
    .menu-lateral {
      background:#ffffff;
      border-radius:12px;
      padding:16px;
      height: calc(100vh - 120px);
      overflow-y:auto;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
    }
    .menu-lateral ul { list-style:none; margin:0; padding:0; }
    .menu-lateral li + li { margin-top:8px; }

    .item-modulo{
      display:flex; align-items:center; justify-content:space-between;
      gap:8px; padding:10px 12px; border-radius:8px; font-weight:600;
    }
    .item-modulo a{
      color:#222; text-decoration:none; display:block; width:100%;
    }
    .item-modulo:hover { background:#f0fadf; }

    .is-active {
      background:#e8f5d7;
      border-left:4px solid #97de66;
      padding-left:8px;
    }

    /* Bloqueado (cadeado) */
    .locked{
      background:#f6f6f6;
      color:#9a9a9a;
      cursor:not-allowed;
      border-left:4px solid #d9d9d9;
      padding-left:8px;
    }
    .locked:hover{ background:#f6f6f6; }
    .lock-icon{ margin-left:8px; opacity:.8; font-weight:700; }

    /* Conte√∫do */
    .conteudo {
      background:#ffffff;
      border-radius:12px;
      padding:16px;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
    }

    .pdf-wrap { position:relative; }
    #pdfFrame {
      width:100%;
      min-height:70vh;
      max-height:85vh;
      border:1px solid #e6e6e6;
      border-radius:10px;
      display:block;
      background:#2b2b2b; /* evita ‚Äúflash‚Äù branco */
    }

    .progress { margin-top:16px; background:#eef5e0; border-radius:10px; height:20px; overflow:hidden; position:relative; }
    .progress-bar { height:100%; background:#4CAF50; transition:width .4s; }
    .progress::after {
      content: attr(data-label);
      position:absolute; left:50%; top:0; transform:translateX(-50%);
      font-weight:700; color:#1b1b1b; font-size:12px; line-height:20px;
    }

    .nav-buttons { margin-top:16px; display:flex; gap:12px; justify-content:flex-end; }
    .btn {
      padding:10px 16px; background:#a0e76d; border:none; border-radius:8px;
      font-weight:700; color:#1b1b1b; cursor:pointer; transition:background .25s;
    }
    .btn:hover { background:#8dd24a; }
    .btn:disabled { background:#dcdcdc; cursor:not-allowed; }

    @media (max-width: 992px) {
      .container { grid-template-columns: 1fr; }
      .menu-lateral { height:auto; margin-bottom:16px; }
      #pdfFrame { min-height:65vh; max-height:70vh; }
    }
    @media (max-width: 600px) {
      #pdfFrame { min-height:60vh; max-height:65vh; }
    }
  </style>
</head>
<body>

  {% set total_mods = (curso.modulos|length) if curso.modulos else 0 %}
  {# Calcula o maior prefixo conclu√≠do 100% (0..k) e libera o k+1 #}
  {% set unlocked_idx = 0 %}
  {% if total_mods > 0 %}
    {% set unlocked_idx = 0 %}
    {% for i in range(total_mods) %}
      {% if progresso_individual and progresso_individual[i] == 100 %}
        {% set unlocked_idx = i + 1 %}
      {% else %}
        {% break %}
      {% endif %}
    {% endfor %}
    {# unlocked_idx agora √© o primeiro m√≥dulo ainda n√£o 100% (ou total_mods se todos 100%) #}
  {% endif %}

  <div class="top-bar">
    Treinamento - {{ curso.nome }}

    <div class="top-actions">
      {# Bot√£o Conclu√≠do aparece √† ESQUERDA do Voltar quando estiver no √∫ltimo m√≥dulo e 100% #}
      {% if curso.modulos and modulo_atual is not none
            and (modulo_atual + 1) == (curso.modulos|length)
            and (progresso|int) >= 100 %}
        <form method="post" action="/concluir/{{ curso.nome }}">
          <button type="submit" class="btn-top btn-concluir-top" aria-label="Concluir e ir para a prova">
            Conclu√≠do
          </button>
        </form>
      {% endif %}

      <a class="btn-top btn-back" href="{{ url_for('home') }}">‚¨Ö Voltar</a>
    </div>
  </div>

  <div class="container">
    <!-- Menu lateral -->
    <div class="menu-lateral">
      <ul>
        {% for mod in curso.modulos %}
          {% set idx = loop.index0 %}
          {% set is_unlocked = (idx <= unlocked_idx) %}
          {% set is_active = (modulo_atual==idx) %}
          <li>
            {% if is_unlocked %}
              <div class="item-modulo {{ 'is-active' if is_active else '' }}">
                <a href="?modulo={{ idx }}">
                  M√≥dulo {{ idx + 1 }} - {{ mod.titulo }}
                  {% if progresso_individual and progresso_individual[idx] == 100 %} ‚úÖ{% endif %}
                </a>
              </div>
            {% else %}
              <div class="item-modulo locked" title="M√≥dulo bloqueado (complete os anteriores)">
                <span>
                  M√≥dulo {{ idx + 1 }} - {{ mod.titulo }}
                </span>
                <span class="lock-icon">üîí</span>
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>

    <!-- Conte√∫do -->
    <div class="conteudo">
      {% if curso.modulos and modulo_atual is not none %}
        {% set raw = (curso.modulos[modulo_atual].arquivo or '') %}
        {% set cleaned = raw.replace('static/','').replace('conteudos/','').lstrip('/') %}
        {% set parts = cleaned.split('/') %}
        {% set fname = parts[-1] %}
        {% set pdf_url = url_for('uploads', filename=fname) %}

        <div class="pdf-wrap">
          <iframe id="pdfFrame" title="Material do m√≥dulo" allow="fullscreen"></iframe>
        </div>

        <small style="opacity:.6; display:block; margin-top:6px;">URL DEBUG: {{ pdf_url }}</small>

        <div class="progress" data-label="{{ progresso }}%">
          <div class="progress-bar" style="width: {{ progresso }}%"></div>
        </div>

        <div class="nav-buttons">
          <form method="get" id="form-anterior">
            <input type="hidden" name="modulo" value="{{ (modulo_atual if modulo_atual is not none else 0) - 1 }}">
            <button class="btn" type="submit"
              {% if not curso.modulos or modulo_atual is none or modulo_atual <= 0 %}disabled{% endif %}>
              ‚Üê Anterior
            </button>
          </form>

          <form method="get" id="form-proximo">
            <input type="hidden" name="modulo" value="{{ (modulo_atual if modulo_atual is not none else -1) + 1 }}">
            <button class="btn" type="submit"
              {# Pr√≥ximo s√≥ habilita se o pr√≥ximo √≠ndice estiver <= unlocked_idx #}
              {% if not curso.modulos or modulo_atual is none or (modulo_atual + 1) > unlocked_idx or (modulo_atual + 1) >= (curso.modulos|length) %}disabled{% endif %}>
              Pr√≥ximo ‚Üí
            </button>
          </form>
        </div>

      {% else %}
        <p>Selecione um m√≥dulo ao lado para visualizar o conte√∫do.</p>
      {% endif %}
    </div>
  </div>

  <!-- Escolhe o viewer correto e garante URL ABSOLUTA -->
  <script>
    (function () {
      var rel = "{{ pdf_url }}";
      var abs = /^https?:\/\//i.test(rel) ? rel : (location.origin + rel);

      var frame = document.getElementById('pdfFrame');

      var ua = navigator.userAgent || navigator.vendor || window.opera;
      var isIOS = /iPad|iPhone|iPod/.test(ua);
      var isAndroid = /Android/i.test(ua);
      var isMobile = isIOS || isAndroid;

      if (isMobile) {
        var gdocs = "https://drive.google.com/viewerng/viewer?embedded=true&url=" + encodeURIComponent(abs);
        frame.src = gdocs;
      } else {
        frame.src = abs + "#zoom=page-width";
      }

      frame.addEventListener('error', function () {
        frame.outerHTML =
          '<div style="padding:12px;background:#fff;border:1px solid #e6e6e6;border-radius:10px;">' +
          'N√£o foi poss√≠vel carregar o visualizador. ' +
          '<a href="'+ abs +'" target="_blank" style="font-weight:bold;color:#2a6;">Abrir o PDF em nova aba</a>' +
          '</div>';
      });
    })();
  </script>

  <!-- Bloqueio de clique em m√≥dulos trancados (defesa no front) -->
  <script>
    document.addEventListener('click', function(e){
      var lockedItem = e.target.closest('.locked');
      if (lockedItem){
        e.preventDefault();
        e.stopPropagation();
        // opcional: feedback visual r√°pido
        lockedItem.style.transition = 'filter .15s';
        lockedItem.style.filter = 'grayscale(30%)';
        setTimeout(function(){ lockedItem.style.filter = 'none'; }, 180);
      }
    });
  </script>

  <!-- Atalhos de teclado -->
  <script>
    document.addEventListener("keydown", function(event) {
      if (event.key === "ArrowLeft") {
        const btnAnterior = document.querySelector("#form-anterior button");
        if (btnAnterior && !btnAnterior.disabled) {
          document.getElementById("form-anterior").submit();
        }
      }
      if (event.key === "ArrowRight") {
        const btnProximo = document.querySelector("#form-proximo button");
        if (btnProximo && !btnProximo.disabled) {
          document.getElementById("form-proximo").submit();
        }
      }
    });
  </script>
</body>
</html>
